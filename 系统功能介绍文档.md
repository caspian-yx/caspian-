# 药品库存管理系统 - 功能介绍文档

## 📋 目录

- [系统概述](#系统概述)
- [核心功能](#核心功能)
- [详细功能说明](#详细功能说明)
- [库存管理逻辑](#库存管理逻辑)
- [业务流程](#业务流程)
- [技术特性](#技术特性)
- [使用说明](#使用说明)

---

## 系统概述

### 系统简介

**药品库存管理系统**是一个基于 Flask + MySQL 的 Web 应用程序，专为医药行业设计，实现了药品的采购、销售、库存管理全流程自动化。系统采用 B/S 架构，支持多用户协作，确保库存数据的实时准确性。

### 技术栈

- **后端框架**：Flask 2.x
- **数据库**：MySQL 8.0
- **ORM**：SQLAlchemy
- **前端**：HTML5 + CSS3 + JavaScript
- **Python 版本**：3.11+

### 系统特点

- ✅ **智能库存管理**：采购和销售审核通过后自动更新库存
- ✅ **新药品自动创建**：采购时输入新药品名称和规格可自动添加到药品库
- ✅ **库存充足性检查**：销售审核前自动检查库存，防止超卖
- ✅ **药品唯一性约束**：通过"药品名称+规格"确保药品唯一性
- ✅ **审核状态管理**：支持未审核、已通过、已驳回三种状态
- ✅ **数据完整性保护**：审核状态变更时自动回退/更新库存
- ✅ **多明细支持**：单据支持多个药品明细
- ✅ **友好的用户界面**：直观的操作界面，错误提示清晰

---

## 核心功能

### 1. 药品管理模块

#### 1.1 药品列表
- **功能**：展示所有药品信息
- **字段**：药品名称、规格、分类、单位、库存、最低库存、零售价
- **操作**：查看、新增、编辑、删除、搜索

#### 1.2 药品分类管理
- **功能**：管理药品分类（西药、中成药、保健品等）
- **操作**：新增分类、编辑分类、删除分类

#### 1.3 单位管理
- **功能**：管理药品计量单位（盒、瓶、片、支等）
- **操作**：新增单位、编辑单位、删除单位

---

### 2. 采购管理模块

#### 2.1 采购单管理
- **功能**：管理药品采购流程
- **支持操作**：
  - 创建采购单
  - 查看采购单详情
  - 编辑采购单（含明细）
  - 删除采购单
  - 审核采购单

#### 2.2 采购明细
- **字段**：药品名称、规格、数量、单价、金额
- **特性**：
  - 支持输入新药品名称和规格
  - 自动创建不存在的药品
  - 支持动态添加多个明细
  - 自动计算金额和合计

#### 2.3 库存更新逻辑（采购）
```
未审核 → 已通过：库存 += 采购数量
已通过 → 未审核：库存 -= 采购数量
已通过 → 已通过（修改数量）：
    1. 库存 -= 旧数量
    2. 库存 += 新数量
删除已通过的采购单：库存 -= 采购数量
```

---

### 3. 销售管理模块

#### 3.1 销售单管理
- **功能**：管理药品销售流程
- **支持操作**：
  - 创建销售单
  - 查看销售单详情
  - 编辑销售单（含明细）
  - 删除销售单
  - 审核销售单

#### 3.2 销售明细
- **字段**：药品名称、规格、数量、单价（零售价）、金额
- **特性**：
  - 只能销售已存在的药品
  - 审核前自动检查库存充足性
  - 库存不足时阻止审核并提示
  - 支持动态添加多个明细
  - 自动计算金额和合计

#### 3.3 库存更新逻辑（销售）
```
未审核 → 已通过：
    1. 检查库存是否充足
    2. 充足则：库存 -= 销售数量
    3. 不足则：阻止审核，显示错误提示
已通过 → 未审核：库存 += 销售数量
已通过 → 已通过（修改数量）：
    1. 库存 += 旧数量（回退）
    2. 检查库存是否充足
    3. 充足则：库存 -= 新数量
删除已通过的销售单：库存 += 销售数量
```

---

### 4. 库存管理模块

#### 4.1 库存查询
- **功能**：实时查看所有药品库存
- **显示字段**：
  - 药品名称
  - 规格
  - 分类
  - 单位
  - 当前库存
  - 最低库存预警值

#### 4.2 库存筛选与排序
- **关键词搜索**：按药品名称、规格、分类搜索
- **分类筛选**：按药品分类过滤
- **排序功能**：按库存数量、药品名称排序

#### 4.3 低库存预警
- **功能**：自动检测低于预警值的药品
- **预警阈值**：可自定义（默认10）
- **显示内容**：预警药品列表，按库存升序排列

---

### 5. 供应商管理模块

#### 5.1 供应商信息管理
- **字段**：
  - 供应商名称（唯一）
  - 药品经营许可证号（唯一）
  - 联系人
  - 电话
  - 地址
- **操作**：新增、编辑、删除、搜索

#### 5.2 关联功能
- 与采购单关联
- 查看供应商的采购历史

---

### 6. 仓库管理模块

#### 6.1 仓库信息管理
- **字段**：
  - 仓库名称（唯一）
  - 仓库类型（常温库、冷藏库、阴凉库）
  - 位置（唯一）
  - 管理员
  - 电话
  - 启用状态

#### 6.2 关联功能
- 与采购单关联
- 与销售单关联

---

### 7. 系统管理模块

#### 7.1 用户管理
- **功能**：管理系统用户账号
- **字段**：用户名、真实姓名、角色、状态
- **操作**：新增用户、编辑用户、禁用/启用用户

#### 7.2 角色权限管理
- **角色类型**：管理员、操作员、查看员
- **权限控制**：基于角色的访问控制

#### 7.3 操作日志
- **功能**：记录所有关键操作
- **记录内容**：操作时间、操作人、操作类型、操作对象

---

## 详细功能说明

### 采购单详细操作流程

#### 1. 创建采购单
1. 点击"新增采购单"按钮
2. 填写基本信息：
   - 选择供应商
   - 选择仓库
   - 选择采购日期（默认当天）
3. 添加采购明细：
   - **方式一**：输入药品名称和规格
     - 如果药品存在，使用现有药品
     - 如果药品不存在，自动创建新药品
   - **方式二**：从下拉列表选择现有药品
4. 填写数量和单价
5. 可添加多个明细
6. 保存采购单（默认状态：未审核）

#### 2. 审核采购单
1. 在采购单列表找到目标单据
2. 点击"编辑"按钮
3. 将"审核状态"改为"已通过"
4. 保存
5. **系统自动执行**：
   - 增加对应药品的库存
   - 如果是新药品，从0开始累加

#### 3. 修改已审核的采购单
1. 编辑采购单
2. 修改明细或数量
3. 保存
4. **系统自动执行**：
   - 先回退旧明细的库存（减少）
   - 再增加新明细的库存
   - 确保库存准确

#### 4. 删除采购单
1. 点击"删除"按钮
2. 确认删除
3. **系统自动执行**：
   - 如果单据已审核，先回退库存
   - 删除明细和主单

---

### 销售单详细操作流程

#### 1. 创建销售单
1. 点击"新增销售单"按钮
2. 填写基本信息：
   - 输入客户名称
   - 选择仓库
   - 选择销售日期（默认当天）
3. 添加销售明细：
   - 输入药品名称和规格（必须是已存在的药品）
   - 填写销售数量
   - 单价自动使用药品的零售价
4. 可添加多个明细
5. 保存销售单（默认状态：未审核）

#### 2. 审核销售单（含库存检查）
1. 在销售单列表找到目标单据
2. 点击"编辑"按钮
3. 将"审核状态"改为"已通过"
4. 保存
5. **系统自动执行**：
   - 逐个检查所有明细的库存是否充足
   - 如果某个药品库存不足：
     - 阻止审核
     - 显示错误提示：`药品【XX XX规格】库存不足！当前库存：X，需要：Y`
   - 如果所有药品库存充足：
     - 扣减对应药品的库存
     - 审核成功

#### 3. 查看销售单详情
1. 点击"查看"按钮
2. 显示完整信息：
   - 基本信息（单号、客户、日期、状态等）
   - 明细列表（药品、规格、数量、单价、金额）
   - 合计金额

---

### 药品管理详细说明

#### 药品唯一性约束

**数据库约束**：
```sql
UNIQUE KEY `uq_medicine_name_spec` (`name`, `specification`)
```

**说明**：
- 药品名称 + 规格 必须唯一
- 例如：
  - ✅ "阿莫西林 0.5g*24片" - 可以存在
  - ✅ "阿莫西林 1.0g*12片" - 可以存在（不同规格）
  - ❌ "阿莫西林 0.5g*24片" - 不能重复添加

#### 新药品自动创建

**触发场景**：采购单中输入新药品名称和规格

**自动创建逻辑**：
```python
if 药品不存在:
    创建新药品:
        - 名称 = 用户输入的名称
        - 规格 = 用户输入的规格
        - 分类 = 默认分类（第一个分类）
        - 单位 = 默认单位（第一个单位）
        - 初始库存 = 0
        - 零售价 = 采购价（首次采购价格）
```

**后续完善**：
- 可在药品列表中编辑新创建的药品
- 修改分类、单位、零售价等信息

---

## 库存管理逻辑

### 核心原则

1. **只有已审核的单据才影响库存**
   - 未审核、已驳回的单据不影响库存
   - 只有审核状态为"已通过"时才更新库存

2. **审核状态变更时自动处理库存**
   - 未审核 → 已通过：更新库存
   - 已通过 → 未审核：回退库存
   - 已通过 → 已通过（修改明细）：先回退再更新

3. **删除单据时自动回退库存**
   - 删除已审核的单据：自动回退库存
   - 删除未审核的单据：无需处理库存

### 库存更新时机

#### 采购单（入库）

| 操作 | 条件 | 库存变化 |
|------|------|----------|
| 审核通过 | 状态：未审核→已通过 | +采购数量 |
| 取消审核 | 状态：已通过→未审核 | -采购数量 |
| 修改已审核单据 | 状态保持已通过 | -旧数量，+新数量 |
| 删除已审核单据 | 状态：已通过 | -采购数量 |
| 删除未审核单据 | 状态：未审核/已驳回 | 不变 |

#### 销售单（出库）

| 操作 | 条件 | 库存变化 |
|------|------|----------|
| 审核通过 | 状态：未审核→已通过 | 先检查库存，充足则-销售数量 |
| 取消审核 | 状态：已通过→未审核 | +销售数量 |
| 修改已审核单据 | 状态保持已通过 | +旧数量，检查后-新数量 |
| 删除已审核单据 | 状态：已通过 | +销售数量 |
| 删除未审核单据 | 状态：未审核/已驳回 | 不变 |

### 库存充足性检查

**触发时机**：销售单审核通过前

**检查逻辑**：
```python
for 每个明细 in 销售单明细:
    if 药品.库存 < 明细.数量:
        阻止审核
        显示错误：
            "药品【{药品名称} {规格}】库存不足！
             当前库存：{实际库存}，需要：{销售数量}"
        return

# 所有明细检查通过后，才扣减库存
for 每个明细 in 销售单明细:
    药品.库存 -= 明细.数量
```

---

## 业务流程

### 完整采购流程

```
1. 创建采购单
   ├─ 输入基本信息（供应商、仓库、日期）
   ├─ 添加采购明细
   │  ├─ 输入药品名称和规格
   │  ├─ 系统自动查找药品
   │  └─ 如不存在，自动创建新药品
   └─ 保存（状态：未审核）

2. 审核采购单
   ├─ 编辑采购单
   ├─ 修改审核状态为"已通过"
   └─ 保存
       └─ 系统自动增加库存 ✅

3. 查看库存变化
   └─ 在药品列表或库存列表中查看库存已更新
```

### 完整销售流程

```
1. 创建销售单
   ├─ 输入基本信息（客户、仓库、日期）
   ├─ 添加销售明细
   │  ├─ 输入药品名称和规格（必须已存在）
   │  └─ 系统自动使用零售价
   └─ 保存（状态：未审核）

2. 审核销售单
   ├─ 编辑销售单
   ├─ 修改审核状态为"已通过"
   └─ 保存
       ├─ 系统自动检查库存
       ├─ 如果库存不足：
       │  └─ 显示错误提示，阻止审核 ❌
       └─ 如果库存充足：
          └─ 系统自动扣减库存 ✅

3. 查看库存变化
   └─ 在药品列表或库存列表中查看库存已更新
```

---

## 技术特性

### 数据库设计

#### 核心表结构

1. **药品表（medicine）**
   - 主键：id（自增）
   - 唯一约束：name + specification
   - 索引：name（查询优化）

2. **采购单主表（purchase）**
   - 主键：purchase_id（字符串，如：IN20251125001）
   - 外键：supplier_id, warehouse_id
   - 关联：采购明细表（一对多）

3. **采购明细表（purchase_detail）**
   - 主键：id（自增）
   - 外键：purchase_id, medicine_id

4. **销售单主表（sale）**
   - 主键：sale_id（字符串，如：OUT20251125001）
   - 外键：warehouse_id
   - 关联：销售明细表（一对多）

5. **销售明细表（sale_detail）**
   - 主键：id（自增）
   - 外键：sale_id, medicine_id

#### 数据完整性保障

- **外键约束**：确保关联数据的完整性
- **唯一约束**：防止重复数据
- **非空约束**：确保关键字段不为空
- **事务处理**：库存更新操作使用事务，确保原子性

### 后端技术

#### ORM 映射

使用 SQLAlchemy 实现 ORM 映射：
- **模型继承**：统一的基础模型
- **关系映射**：一对多、多对一关系
- **字段别名**：兼容旧代码的字段别名
- **延迟加载**：优化查询性能

#### 路由设计

采用蓝图（Blueprint）模块化设计：
- `inbound_bp`：采购管理
- `outbound_bp`：销售管理
- `stock_bp`：库存管理
- `material_bp`：药品管理
- `supplier_bp`：供应商管理
- `warehouse_bp`：仓库管理
- `system_bp`：系统管理

#### 错误处理

- **异常捕获**：所有数据库操作都有异常处理
- **事务回滚**：操作失败时自动回滚
- **友好提示**：向用户显示清晰的错误信息

### 前端技术

#### 动态表单

- **动态添加明细**：JavaScript 实现动态添加/删除明细行
- **表单验证**：HTML5 + JavaScript 双重验证
- **自动计算**：金额自动计算

#### 用户体验

- **搜索功能**：实时搜索，支持多字段
- **排序功能**：表格支持多种排序方式
- **分页显示**：大数据量时分页加载
- **响应式设计**：适配不同屏幕尺寸

---

## 使用说明

### 系统部署

#### 环境要求

- Python 3.11+
- MySQL 8.0+
- 浏览器：Chrome/Firefox/Edge 最新版

#### 安装步骤

1. **创建虚拟环境**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **配置数据库**
   - 编辑 `config.py`
   - 修改数据库连接信息

4. **初始化数据库**
   ```bash
   mysql -u root -p < 创建数据库.sql
   python data_init.py
   ```

5. **启动服务**
   ```bash
   python run.py
   ```

6. **访问系统**
   - 浏览器打开：`http://localhost:5000`
   - 默认账号：admin / admin123

### 常见问题

#### Q1：采购新药品后库存没有更新？
**A**：请检查采购单的审核状态，只有"已通过"的采购单才会更新库存。

#### Q2：销售时提示库存不足？
**A**：这是正常的库存检查机制，请先采购补充库存，或减少销售数量。

#### Q3：如何修改已审核的单据？
**A**：可以直接编辑，系统会自动回退旧库存并更新新库存。

#### Q4：删除单据会影响库存吗？
**A**：是的，删除已审核的单据会自动回退库存，确保数据一致性。

#### Q5：药品名称和规格重复怎么办？
**A**：系统不允许添加重复的"名称+规格"组合，请修改规格或名称。

---

## 系统优势

### 业务优势

1. **自动化程度高**
   - 库存自动更新，无需人工干预
   - 新药品自动创建，简化操作流程
   - 库存检查自动执行，防止超卖

2. **数据准确性强**
   - 严格的唯一性约束
   - 完整的事务处理
   - 自动的数据校验

3. **操作简便**
   - 直观的用户界面
   - 清晰的操作提示
   - 灵活的单据管理

### 技术优势

1. **可扩展性好**
   - 模块化设计
   - 蓝图架构
   - ORM 映射

2. **维护性强**
   - 代码结构清晰
   - 注释完整
   - 错误处理完善

3. **性能优秀**
   - 数据库索引优化
   - 延迟加载
   - 查询优化

---

## 未来规划

### 短期规划

- [ ] 增加批次管理功能
- [ ] 支持有效期管理
- [ ] 添加库存报警通知
- [ ] 优化移动端适配

### 中期规划

- [ ] 实现多仓库管理
- [ ] 添加财务统计模块
- [ ] 支持数据导出（Excel）
- [ ] 增加高级权限控制

### 长期规划

- [ ] 开发移动应用
- [ ] 集成扫码枪功能
- [ ] 实现智能补货建议
- [ ] 对接第三方ERP系统

---

## 联系方式

- **系统名称**：药品库存管理系统
- **版本**：v1.0
- **更新日期**：2025-11-25
- **技术支持**：系统管理员

---

## 附录

### 数据库表结构说明

#### 药品表（medicine）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 药品名称 |
| generic_name | VARCHAR(100) | 通用名称 |
| approval_number | VARCHAR(50) | 批准文号 |
| specification | VARCHAR(100) | 规格 |
| dosage_form | VARCHAR(50) | 剂型 |
| manufacturer | VARCHAR(200) | 生产厂家 |
| category_id | INT | 分类ID（外键） |
| unit_id | INT | 单位ID（外键） |
| is_prescription | INT | 是否处方药（0否1是） |
| stock | INT | 当前库存 |
| min_stock | INT | 最低库存预警 |
| retail_price | FLOAT | 零售价 |
| create_time | DATETIME | 创建时间 |
| remark | VARCHAR(500) | 备注 |

#### 采购单主表（purchase）

| 字段 | 类型 | 说明 |
|------|------|------|
| purchase_id | VARCHAR(50) | 主键，采购单号 |
| supplier_id | INT | 供应商ID（外键） |
| warehouse_id | INT | 仓库ID（外键） |
| purchase_date | DATE | 采购日期 |
| total_amount | FLOAT | 总金额 |
| remark | TEXT | 备注 |
| audit_status | INT | 审核状态（0未审核1已通过2已驳回） |
| create_time | DATETIME | 创建时间 |

#### 采购明细表（purchase_detail）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| purchase_id | VARCHAR(50) | 采购单号（外键） |
| medicine_id | INT | 药品ID（外键） |
| production_batch | VARCHAR(50) | 生产批次 |
| production_date | DATE | 生产日期 |
| expiry_date | DATE | 有效期 |
| quantity | INT | 数量 |
| unit_price | FLOAT | 单价 |
| amount | FLOAT | 金额 |

### 审核状态说明

| 状态值 | 状态名称 | 说明 | 颜色标识 |
|--------|----------|------|----------|
| 0 | 未审核 | 单据已创建但未审核 | 黄色 |
| 1 | 已通过 | 单据已审核通过，库存已更新 | 绿色 |
| 2 | 已驳回 | 单据被驳回，不影响库存 | 红色 |

### 快捷键说明

| 快捷键 | 功能 |
|--------|------|
| Ctrl + S | 保存当前表单 |
| Ctrl + F | 打开搜索框 |
| ESC | 关闭弹窗 |

---

**文档版本**：v1.0
**最后更新**：2025-11-25
**适用系统版本**：药品库存管理系统 v1.0
